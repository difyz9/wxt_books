# 开发环境搭建

## 环境准备概览

本章将指导你搭建一个完整的 WXT 开发环境，包括所有必需的工具和配置。

### 环境要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Node.js**: 16.0+ (推荐 18.0+)
- **包管理器**: npm, yarn, 或 pnpm
- **浏览器**: Chrome 88+, Firefox 88+
- **编辑器**: VS Code (推荐)

## 第一步：基础环境安装

### 1. Node.js 安装

#### 方式一：官网下载 (推荐新手)
```bash
# 访问 https://nodejs.org
# 下载 LTS 版本
# 按照安装向导完成安装
```

#### 方式二：使用 nvm (推荐开发者)
```bash
# macOS/Linux
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重启终端后
nvm install 18
nvm use 18
nvm alias default 18

# Windows (使用 nvm-windows)
# 从 GitHub 下载安装包
# https://github.com/coreybutler/nvm-windows
```

#### 验证安装
```bash
node --version   # 应显示 v18.x.x
npm --version    # 应显示 9.x.x
```

### 2. 包管理器选择

#### npm (默认)
```bash
# 已随 Node.js 安装
npm --version
```

#### yarn (可选)
```bash
npm install -g yarn
yarn --version
```

#### pnpm (推荐，更快更省空间)
```bash
npm install -g pnpm
pnpm --version
```

### 3. Git 安装和配置
```bash
# 安装 Git (如果未安装)
# Windows: 从 https://git-scm.com 下载
# macOS: brew install git
# Ubuntu: sudo apt install git

# 配置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 验证配置
git config --list
```

## 第二步：VS Code 配置

### 1. VS Code 安装
```bash
# 从 https://code.visualstudio.com 下载安装
# 或使用包管理器
# macOS: brew install --cask visual-studio-code
# Ubuntu: sudo snap install code --classic
```

### 2. 必装扩展
```json
{
  "recommendations": [
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-eslint",
    "formulahendry.auto-rename-tag",
    "christian-kohler.path-intellisense",
    "ms-vscode.vscode-json",
    "ms-vscode.vscode-chrome-debug"
  ]
}
```

### 3. VS Code 设置优化
```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.preferences.importModuleSpecifier": "relative",
  "emmet.includeLanguages": {
    "typescript": "html",
    "typescriptreact": "html"
  },
  "tailwindCSS.includeLanguages": {
    "typescript": "html",
    "typescriptreact": "html"
  }
}
```

### 4. 调试配置
```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Launch Chrome Extension",
      "type": "chrome",
      "request": "launch",
      "url": "chrome://extensions/",
      "webRoot": "${workspaceFolder}"
    }
  ]
}
```

## 第三步：WXT 项目创建

### 1. 创建新项目
```bash
# 使用 npm
npm create wxt@latest my-extension

# 使用 yarn
yarn create wxt my-extension

# 使用 pnpm
pnpm create wxt my-extension
```

### 2. 项目模板选择
```bash
? Select a template: (Use arrow keys)
❯ vanilla        # 纯 JavaScript
  vanilla-ts     # TypeScript
  react          # React + JavaScript
  react-ts       # React + TypeScript (推荐)
  vue            # Vue.js
  vue-ts         # Vue.js + TypeScript
  svelte         # Svelte
  svelte-ts      # Svelte + TypeScript
```

选择 `react-ts` 获得最佳开发体验。

### 3. 项目结构解析
```
my-extension/
├── .wxt/                   # WXT 构建缓存
├── assets/                 # 静态资源
│   └── icon/              # 扩展图标
├── components/            # React 组件
├── entrypoints/           # 入口点
│   ├── background.ts      # 后台脚本
│   ├── content.ts         # 内容脚本
│   ├── popup/             # 弹窗页面
│   │   ├── index.html
│   │   ├── App.tsx
│   │   └── main.tsx
│   └── options/           # 设置页面
│       ├── index.html
│       ├── App.tsx
│       └── main.tsx
├── public/                # 公共静态文件
├── utils/                 # 工具函数
├── package.json
├── wxt.config.ts         # WXT 配置文件
├── tsconfig.json         # TypeScript 配置
├── tailwind.config.js    # Tailwind CSS 配置
└── README.md
```

### 4. 安装依赖
```bash
cd my-extension
npm install

# 或
yarn install

# 或
pnpm install
```

## 第四步：WXT 配置详解

### 1. 基础配置文件
```typescript
// wxt.config.ts
import { defineConfig } from 'wxt';

export default defineConfig({
  // 扩展元数据
  manifest: {
    name: '我的第一个扩展',
    description: '使用 WXT 开发的现代化扩展',
    version: '1.0.0',
    permissions: ['activeTab', 'storage'],
  },
  
  // 开发服务器配置
  dev: {
    server: {
      port: 3000,
      hostname: 'localhost'
    }
  },
  
  // 构建配置
  build: {
    outDir: 'dist'
  },
  
  // Vite 配置
  vite: () => ({
    define: {
      __DEV__: JSON.stringify(process.env.NODE_ENV === 'development')
    }
  })
});
```

### 2. TypeScript 配置
```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,

    /* Path mapping */
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "~/*": ["./*"]
    }
  },
  "include": ["**/*.ts", "**/*.tsx", "**/*.vue"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### 3. Tailwind CSS 配置
```javascript
// tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./entrypoints/**/*.{html,js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
        }
      }
    },
  },
  plugins: [],
}
```

## 第五步：开发服务器启动

### 1. 启动开发模式
```bash
# 启动开发服务器
npm run dev

# 或
yarn dev

# 或
pnpm dev
```

### 2. 开发服务器特性
```
✅ 热重载 (Hot Reload)
✅ 类型检查
✅ 样式实时更新
✅ 错误提示
✅ 自动刷新扩展
```

### 3. 构建产品版本
```bash
# 构建生产版本
npm run build

# 构建并压缩
npm run zip
```

## 第六步：Chrome 浏览器配置

### 1. 开启开发者模式
1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 右上角开启"开发者模式"

### 2. 加载扩展
```bash
# 方式一：拖拽安装
# 将构建后的 .crx 文件拖到扩展页面

# 方式二：加载已解压的扩展程序
# 点击"加载已解压的扩展程序"
# 选择项目的 .output 或 dist 目录
```

### 3. 调试工具使用

#### 调试 Background Script
```bash
1. 扩展管理页面 → 找到你的扩展
2. 点击"检查视图: 背景页"
3. 在 DevTools 中调试
```

#### 调试 Content Script
```bash
1. 打开包含扩展的网页
2. 按 F12 打开开发者工具
3. 在 Console 中可以看到 content script 输出
```

#### 调试 Popup
```bash
1. 右键点击扩展图标
2. 选择"检查"
3. 在弹出的 DevTools 中调试
```

## 第七步：Hello World 示例

### 1. 创建简单的 Popup
```typescript
// entrypoints/popup/App.tsx
import React, { useState } from 'react';
import './App.css';

function App() {
  const [count, setCount] = useState(0);

  const handleClick = async () => {
    const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
    const tab = tabs[0];
    
    chrome.tabs.sendMessage(tab.id!, {
      action: 'highlight',
      count: count + 1
    });
    
    setCount(count + 1);
  };

  return (
    <div className="w-80 p-4">
      <h1 className="text-xl font-bold mb-4">Hello WXT!</h1>
      <div className="flex flex-col gap-2">
        <p className="text-gray-600">点击次数: {count}</p>
        <button 
          onClick={handleClick}
          className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
        >
          高亮页面元素
        </button>
      </div>
    </div>
  );
}

export default App;
```

### 2. 创建 Content Script
```typescript
// entrypoints/content.ts
import { defineContentScript } from 'wxt/sandbox';

export default defineContentScript({
  matches: ['<all_urls>'],
  main() {
    console.log('Content script loaded!');
    
    // 监听来自 popup 的消息
    chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
      if (message.action === 'highlight') {
        highlightRandomElement();
        sendResponse({ success: true });
      }
    });
    
    function highlightRandomElement() {
      // 移除之前的高亮
      document.querySelectorAll('.wxt-highlight').forEach(el => {
        el.classList.remove('wxt-highlight');
      });
      
      // 随机高亮一个段落
      const paragraphs = document.querySelectorAll('p');
      if (paragraphs.length > 0) {
        const randomP = paragraphs[Math.floor(Math.random() * paragraphs.length)];
        randomP.classList.add('wxt-highlight');
      }
    }
  },
  cssInjectionMode: 'ui'
});
```

### 3. 添加样式
```css
/* entrypoints/content.css */
.wxt-highlight {
  background-color: yellow !important;
  border: 2px solid orange !important;
  padding: 4px !important;
  border-radius: 4px !important;
  transition: all 0.3s ease !important;
}
```

### 4. 配置 Background Script
```typescript
// entrypoints/background.ts
import { defineBackground } from 'wxt/sandbox';

export default defineBackground({
  type: 'module',
  main() {
    console.log('Background script started!');
    
    // 扩展安装时的处理
    chrome.runtime.onInstalled.addListener(() => {
      console.log('Extension installed!');
    });
    
    // 监听标签页更新
    chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
      if (changeInfo.status === 'complete' && tab.url) {
        console.log('Page loaded:', tab.url);
      }
    });
  }
});
```

## 第八步：测试和调试

### 1. 功能测试清单
```bash
✅ 扩展图标显示正常
✅ Popup 页面可以打开
✅ 按钮点击功能正常
✅ Content script 注入成功
✅ 消息传递工作正常
✅ 样式应用正确
✅ 控制台无错误信息
```

### 2. 常见问题排查

#### 问题 1: 扩展不加载
```bash
解决方案:
1. 检查 manifest.json 语法
2. 验证权限配置
3. 查看控制台错误信息
4. 重新构建项目
```

#### 问题 2: Content Script 不执行
```bash
解决方案:
1. 检查 matches 配置
2. 确认页面 URL 匹配
3. 查看 content script 错误
4. 验证权限声明
```

#### 问题 3: 热重载不工作
```bash
解决方案:
1. 重启开发服务器
2. 重新加载扩展
3. 清除浏览器缓存
4. 检查端口冲突
```

### 3. 调试技巧
```javascript
// 1. 使用 console.log 调试
console.log('Debug info:', data);

// 2. 使用 debugger 断点
debugger;

// 3. 检查扩展状态
chrome.management.getSelf(console.log);

// 4. 监控错误
window.addEventListener('error', (e) => {
  console.error('Extension error:', e);
});
```

## 第九步：项目版本控制

### 1. Git 初始化
```bash
cd my-extension
git init
git add .
git commit -m "Initial commit"
```

### 2. .gitignore 配置
```gitignore
# Dependencies
node_modules/
.pnp
.pnp.js

# Production builds
dist/
.output/
*.crx
*.zip

# Development
.wxt/
.DS_Store
.vscode/settings.json

# Environment variables
.env
.env.local
.env.production

# Logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# Runtime data
*.pid
*.seed
*.pid.lock
```

### 3. 提交规范
```bash
# 功能开发
git commit -m "feat: add content script highlighting"

# 问题修复
git commit -m "fix: resolve popup display issue"

# 文档更新
git commit -m "docs: update README.md"

# 样式调整
git commit -m "style: improve button hover effects"
```

## 实践任务

### 任务 1: 环境验证
创建一个简单的扩展，包含：
- [ ] Popup 显示当前时间
- [ ] Content script 在页面加载时显示通知
- [ ] Background script 记录浏览历史

### 任务 2: 开发工具熟悉
使用 Chrome DevTools 完成：
- [ ] 在 popup 中设置断点
- [ ] 查看 background script 日志
- [ ] 检查 content script 网络请求
- [ ] 分析扩展性能

### 任务 3: 配置优化
自定义项目配置：
- [ ] 修改 Tailwind 主题色
- [ ] 配置 TypeScript 路径别名
- [ ] 设置 ESLint 规则
- [ ] 配置 Prettier 格式化

## 故障排除指南

### 常见错误及解决方案

| 错误类型 | 症状 | 解决方案 |
|---------|------|---------|
| 权限错误 | API 调用失败 | 检查 manifest.json 权限 |
| 路径错误 | 资源加载失败 | 使用相对路径或 chrome.runtime.getURL |
| 类型错误 | TypeScript 编译失败 | 安装 @types 包或添加类型声明 |
| 样式问题 | CSS 不生效 | 检查 CSP 策略和样式注入方式 |
| 热重载问题 | 修改不生效 | 重启开发服务器或重新加载扩展 |

### 性能优化建议
1. **代码分割**: 使用动态导入减少初始包大小
2. **懒加载**: 按需加载组件和资源
3. **缓存策略**: 合理使用 localStorage 和 chrome.storage
4. **资源优化**: 压缩图片和字体文件

## 总结

完成本章学习后，你已经：

✅ **搭建了完整的开发环境**
- Node.js 和包管理器
- VS Code 和必要扩展
- WXT 项目和配置

✅ **掌握了基本的开发流程**
- 项目创建和结构
- 开发服务器使用
- 调试工具应用

✅ **创建了第一个扩展项目**
- Hello World 示例
- 基本功能实现
- 测试和调试

✅ **了解了开发最佳实践**
- 版本控制
- 错误处理
- 性能优化

下一步，我们将进入第二阶段，深入学习 React、TypeScript 和 Tailwind CSS 在 WXT 项目中的应用。

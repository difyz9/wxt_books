# Web æ‰©å±•åŸºç¡€æ¦‚å¿µ

## ä»€ä¹ˆæ˜¯ Web æ‰©å±•ï¼Ÿ

Web æ‰©å±•ï¼ˆWeb Extensionsï¼‰æ˜¯ä¸€ç§å¯ä»¥å¢å¼ºæˆ–ä¿®æ”¹æµè§ˆå™¨åŠŸèƒ½çš„è½¯ä»¶ç¨‹åºã€‚å®ƒä»¬å¯ä»¥ï¼š

- ğŸ”§ ä¿®æ”¹ç½‘é¡µå†…å®¹å’Œè¡Œä¸º
- ğŸ¨ æ”¹å˜æµè§ˆå™¨ç•Œé¢
- ğŸ”— ä¸å¤–éƒ¨æœåŠ¡äº¤äº’
- ğŸ“Š æ”¶é›†å’Œå¤„ç†æ•°æ®
- ğŸ›¡ï¸ æä¾›éšç§å’Œå®‰å…¨åŠŸèƒ½

## æ‰©å±•çš„å‘å±•å†å²

### Chrome æ‰©å±•æ¼”è¿›
```
2009 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2020 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2023
  â”‚               â”‚               â”‚
Manifest V1    Manifest V2    Manifest V3
(å·²åºŸå¼ƒ)        (é€æ¸æ·˜æ±°)      (å½“å‰æ ‡å‡†)
```

### ä¸»è¦å˜åŒ–
| ç‰ˆæœ¬ | ç‰¹ç‚¹ | çŠ¶æ€ |
|------|------|------|
| V1 | åŸºç¡€åŠŸèƒ½ï¼Œå®‰å…¨æ€§è¾ƒå·® | å·²åºŸå¼ƒ |
| V2 | æƒé™ç³»ç»Ÿï¼Œåå°é¡µé¢ | é€æ¸æ·˜æ±° |
| V3 | æœåŠ¡å·¥ä½œçº¿ç¨‹ï¼Œæ›´å¼ºå®‰å…¨æ€§ | å½“å‰ä¸»æµ |

## Manifest V3 æ ¸å¿ƒç‰¹æ€§

### 1. æœåŠ¡å·¥ä½œçº¿ç¨‹ (Service Workers)
```javascript
// æ›¿ä»£ä¼ ç»Ÿçš„èƒŒæ™¯é¡µé¢
// background.js
chrome.runtime.onInstalled.addListener(() => {
  console.log('æ‰©å±•å·²å®‰è£…');
});

// ç›‘å¬æ¶ˆæ¯
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  // å¤„ç†æ¥è‡ª content script çš„æ¶ˆæ¯
});
```

### 2. å£°æ˜å¼ç½‘ç»œè¯·æ±‚
```json
{
  "declarative_net_request": {
    "rule_resources": [{
      "id": "ruleset_1",
      "enabled": true,
      "path": "rules.json"
    }]
  }
}
```

### 3. æ›´ä¸¥æ ¼çš„å†…å®¹å®‰å…¨ç­–ç•¥
```json
{
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self'"
  }
}
```

## æ‰©å±•æ¶æ„ç»„ä»¶

### æ ¸å¿ƒç»„ä»¶å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Chrome æµè§ˆå™¨               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Popup    â”‚  â”‚   Background/SW     â”‚ â”‚
â”‚  â”‚   (å¼¹çª—)     â”‚  â”‚   (åå°æœåŠ¡)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Options   â”‚  â”‚   Content Script    â”‚ â”‚
â”‚  â”‚   (è®¾ç½®é¡µ)   â”‚  â”‚   (å†…å®¹è„šæœ¬)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. Background Script / Service Worker
**ä½œç”¨**: æ‰©å±•çš„"å¤§è„‘"ï¼Œå¤„ç†åå°é€»è¾‘

```javascript
// å…¸å‹ç”¨é€”
- ç›‘å¬æµè§ˆå™¨äº‹ä»¶
- å¤„ç†ç½‘ç»œè¯·æ±‚
- ç®¡ç†æ‰©å±•çŠ¶æ€
- ä¸å…¶ä»–ç»„ä»¶é€šä¿¡
```

**ç”Ÿå‘½å‘¨æœŸ**:
```
å®‰è£… â†’ å¯åŠ¨ â†’ ä¼‘çœ  â†’ å”¤é†’ â†’ å¸è½½
```

### 2. Content Scripts
**ä½œç”¨**: åœ¨ç½‘é¡µä¸­è¿è¡Œçš„è„šæœ¬ï¼Œå¯ä»¥è¯»å–å’Œä¿®æ”¹é¡µé¢å†…å®¹

```javascript
// content.js
// å¯ä»¥è®¿é—®é¡µé¢ DOM
const title = document.title;

// å¯ä»¥ä¸èƒŒæ™¯è„šæœ¬é€šä¿¡
chrome.runtime.sendMessage({
  action: 'pageInfo',
  title: title,
  url: window.location.href
});

// å¯ä»¥æ³¨å…¥ CSS
const style = document.createElement('style');
style.textContent = '.highlight { background: yellow; }';
document.head.appendChild(style);
```

**é™åˆ¶**:
- ä¸èƒ½è®¿é—®æ‰©å±• API
- ä¸èƒ½è®¿é—®å…¶ä»–æ ‡ç­¾é¡µ
- ä¸é¡µé¢è„šæœ¬éš”ç¦»

### 3. Popup
**ä½œç”¨**: ç‚¹å‡»æ‰©å±•å›¾æ ‡æ—¶æ˜¾ç¤ºçš„å°çª—å£

```html
<!-- popup.html -->
<!DOCTYPE html>
<html>
<head>
  <style>
    body { width: 300px; padding: 20px; }
    .button { padding: 10px; margin: 5px; }
  </style>
</head>
<body>
  <h1>æˆ‘çš„æ‰©å±•</h1>
  <button id="action-btn">æ‰§è¡Œæ“ä½œ</button>
  <script src="popup.js"></script>
</body>
</html>
```

### 4. Options Page
**ä½œç”¨**: æ‰©å±•çš„è®¾ç½®ç•Œé¢

```html
<!-- options.html -->
<!DOCTYPE html>
<html>
<head>
  <title>æ‰©å±•è®¾ç½®</title>
</head>
<body>
  <h1>è®¾ç½®</h1>
  <form>
    <label>
      <input type="checkbox" id="feature1"> å¯ç”¨åŠŸèƒ½1
    </label>
    <br>
    <label>
      API Key: <input type="text" id="apiKey">
    </label>
    <br>
    <button type="button" id="save">ä¿å­˜è®¾ç½®</button>
  </form>
  <script src="options.js"></script>
</body>
</html>
```

## æ¶ˆæ¯ä¼ é€’æœºåˆ¶

### ç»„ä»¶é—´é€šä¿¡
```javascript
// Content Script â†’ Background
chrome.runtime.sendMessage({
  action: 'getData',
  params: { id: 123 }
}, (response) => {
  console.log('æ”¶åˆ°å›å¤:', response);
});

// Background â†’ Content Script
chrome.tabs.sendMessage(tabId, {
  action: 'updateUI',
  data: newData
});

// Popup â†’ Background
chrome.runtime.getBackgroundPage((bg) => {
  bg.someFunction();
});
```

### é•¿è¿æ¥é€šä¿¡
```javascript
// å»ºç«‹é•¿è¿æ¥
const port = chrome.runtime.connect({ name: 'content-background' });

// å‘é€æ¶ˆæ¯
port.postMessage({ action: 'start' });

// ç›‘å¬æ¶ˆæ¯
port.onMessage.addListener((msg) => {
  console.log('æ”¶åˆ°æ¶ˆæ¯:', msg);
});
```

## æƒé™ç³»ç»Ÿ

### å¸¸ç”¨æƒé™
```json
{
  "permissions": [
    "activeTab",      // å½“å‰æ ‡ç­¾é¡µ
    "storage",        // å­˜å‚¨æ•°æ®
    "alarms",         // å®šæ—¶å™¨
    "notifications",  // é€šçŸ¥
    "contextMenus"    // å³é”®èœå•
  ],
  "host_permissions": [
    "https://*.example.com/*",  // ç‰¹å®šåŸŸå
    "<all_urls>"                // æ‰€æœ‰ç½‘ç«™
  ]
}
```

### æƒé™æœ€ä½³å®è·µ
1. **æœ€å°æƒé™åŸåˆ™**: åªç”³è¯·å¿…éœ€çš„æƒé™
2. **åŠ¨æ€æƒé™**: åœ¨éœ€è¦æ—¶ç”³è¯·æƒé™
3. **ç”¨æˆ·å‹å¥½**: è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦æƒé™

## WXT æ¡†æ¶ä¼˜åŠ¿

### ä¼ ç»Ÿå¼€å‘ vs WXT å¼€å‘

| æ–¹é¢ | ä¼ ç»Ÿå¼€å‘ | WXT å¼€å‘ |
|------|----------|----------|
| é…ç½® | æ‰‹åŠ¨é…ç½® manifest | è‡ªåŠ¨ç”Ÿæˆ |
| çƒ­é‡è½½ | éœ€è¦æ‰‹åŠ¨åˆ·æ–° | è‡ªåŠ¨çƒ­é‡è½½ |
| TypeScript | éœ€è¦é…ç½® | å¼€ç®±å³ç”¨ |
| æ„å»ºä¼˜åŒ– | æ‰‹åŠ¨é…ç½® | è‡ªåŠ¨ä¼˜åŒ– |
| å¼€å‘ä½“éªŒ | å¤æ‚ | ç®€åŒ– |

### WXT æ ¸å¿ƒç‰¹æ€§
```typescript
// 1. ç±»å‹å®‰å…¨
import { defineContentScript } from 'wxt/sandbox';

export default defineContentScript({
  matches: ['https://example.com/*'],
  main() {
    console.log('Hello from content script!');
  }
});

// 2. è‡ªåŠ¨åŒ–é…ç½®
// wxt.config.ts
export default defineConfig({
  manifest: {
    name: 'My Extension',
    permissions: ['activeTab']
  }
});

// 3. ç»„ä»¶åŒ–å¼€å‘
// popup/App.tsx
import React from 'react';

export default function App() {
  return (
    <div className="p-4">
      <h1 className="text-xl font-bold">æˆ‘çš„æ‰©å±•</h1>
    </div>
  );
}
```

## å¼€å‘å·¥ä½œæµ

### å…¸å‹å¼€å‘æµç¨‹
```mermaid
graph TD
    A[åˆ›å»ºé¡¹ç›®] --> B[é…ç½® manifest]
    B --> C[å¼€å‘ç»„ä»¶]
    C --> D[æœ¬åœ°æµ‹è¯•]
    D --> E[æ„å»ºæ‰“åŒ…]
    E --> F[å‘å¸ƒåº”ç”¨]
    
    D --> G[å‘ç°é—®é¢˜]
    G --> C
```

### è°ƒè¯•å·¥å…·
1. **Chrome DevTools**: è°ƒè¯• popup å’Œ options
2. **Background Console**: è°ƒè¯• service worker
3. **Content Script Debugger**: è°ƒè¯•å†…å®¹è„šæœ¬
4. **WXT Dev Server**: çƒ­é‡è½½å¼€å‘

## å¸¸è§ä½¿ç”¨åœºæ™¯

### 1. å†…å®¹å¢å¼º
- ç½‘é¡µå†…å®¹æ ‡æ³¨
- ç¿»è¯‘å·¥å…·
- å¹¿å‘Šæ‹¦æˆª
- æ ·å¼ç¾åŒ–

### 2. ç”Ÿäº§åŠ›å·¥å…·
- å¯†ç ç®¡ç†
- ä¹¦ç­¾åŒæ­¥
- æˆªå›¾å·¥å…·
- æ—¶é—´è·Ÿè¸ª

### 3. å¼€å‘å·¥å…·
- API æµ‹è¯•
- æ€§èƒ½ç›‘æ§
- ä»£ç æ ¼å¼åŒ–
- è°ƒè¯•è¾…åŠ©

### 4. ç¤¾äº¤å’Œå¨±ä¹
- ç¤¾äº¤åª’ä½“å¢å¼º
- è§†é¢‘ä¸‹è½½
- æ¸¸æˆè¾…åŠ©
- å†…å®¹èšåˆ

## å®‰å…¨è€ƒè™‘

### å¸¸è§å®‰å…¨é£é™©
1. **XSS æ”»å‡»**: ä¸å®‰å…¨çš„å†…å®¹æ³¨å…¥
2. **æƒé™æ»¥ç”¨**: è¿‡åº¦ç”³è¯·æƒé™
3. **æ•°æ®æ³„éœ²**: ä¸å®‰å…¨çš„æ•°æ®å­˜å‚¨
4. **æ¶æ„ä»£ç **: ç¬¬ä¸‰æ–¹åº“é£é™©

### å®‰å…¨æœ€ä½³å®è·µ
```javascript
// 1. è¾“å…¥éªŒè¯
function sanitizeInput(input) {
  return input.replace(/[<>\"'&]/g, (char) => {
    const entities = {
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '&': '&amp;'
    };
    return entities[char];
  });
}

// 2. å®‰å…¨çš„æ¶ˆæ¯ä¼ é€’
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  // éªŒè¯æ¶ˆæ¯æ¥æº
  if (!sender.tab || !message.action) {
    return;
  }
  
  // éªŒè¯æ¶ˆæ¯æ ¼å¼
  if (typeof message.data !== 'object') {
    return;
  }
  
  // å¤„ç†æ¶ˆæ¯...
});

// 3. å®‰å…¨çš„å­˜å‚¨
chrome.storage.local.set({
  // é¿å…å­˜å‚¨æ•æ„Ÿä¿¡æ¯
  preferences: encryptData(userPreferences)
});
```

## å®è·µç»ƒä¹ 

### ç»ƒä¹  1: åˆ†ææ‰©å±•æ¶æ„
é€‰æ‹© 3 ä¸ªä¸åŒç±»å‹çš„ Chrome æ‰©å±•ï¼Œåˆ†æå®ƒä»¬çš„ï¼š
- ä¸»è¦åŠŸèƒ½
- ä½¿ç”¨çš„ç»„ä»¶
- æƒé™éœ€æ±‚
- ç”¨æˆ·äº¤äº’æ–¹å¼

### ç»ƒä¹  2: ç»˜åˆ¶æ¶æ„å›¾
ä¸ºä»¥ä¸‹æ‰©å±•ç±»å‹ç»˜åˆ¶æ¶æ„å›¾ï¼š
1. ç½‘é¡µç¿»è¯‘å·¥å…·
2. å¯†ç ç®¡ç†å™¨
3. å¹¿å‘Šæ‹¦æˆªå™¨

### ç»ƒä¹  3: æƒé™åˆ†æ
åˆ—å‡ºä»¥ä¸‹åŠŸèƒ½éœ€è¦çš„æƒé™ï¼š
- è¯»å–å½“å‰é¡µé¢å†…å®¹
- å‘é€ç½‘ç»œè¯·æ±‚
- æ˜¾ç¤ºé€šçŸ¥
- è®¿é—®æµè§ˆå†å²

## æ€»ç»“

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ åº”è¯¥æŒæ¡ï¼š

âœ… **Web æ‰©å±•çš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†**
- ç†è§£æ‰©å±•çš„ä½œç”¨å’Œä»·å€¼
- æŒæ¡ Manifest V3 çš„æ–°ç‰¹æ€§
- äº†è§£æ‰©å±•çš„å‘å±•è¶‹åŠ¿

âœ… **æ‰©å±•æ¶æ„çš„æ ¸å¿ƒç»„ä»¶**
- Background Script/Service Worker
- Content Scripts
- Popup å’Œ Options é¡µé¢
- ç»„ä»¶é—´çš„é€šä¿¡æœºåˆ¶

âœ… **WXT æ¡†æ¶çš„ä¼˜åŠ¿**
- ç®€åŒ–çš„å¼€å‘æµç¨‹
- ç±»å‹å®‰å…¨çš„å¼€å‘ä½“éªŒ
- è‡ªåŠ¨åŒ–çš„æ„å»ºä¼˜åŒ–

âœ… **å®‰å…¨å’Œæœ€ä½³å®è·µ**
- æƒé™ç³»ç»Ÿçš„ä½¿ç”¨
- å®‰å…¨å¼€å‘çš„æ³¨æ„äº‹é¡¹
- æ€§èƒ½ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™

ä¸‹ä¸€ç« æˆ‘ä»¬å°†è¿›å…¥å®è·µç¯èŠ‚ï¼Œå­¦ä¹ å¦‚ä½•æ­å»ºå®Œæ•´çš„å¼€å‘ç¯å¢ƒå¹¶åˆ›å»ºç¬¬ä¸€ä¸ª WXT æ‰©å±•é¡¹ç›®ã€‚
